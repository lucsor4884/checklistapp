<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de Lojas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-active { color: #FF3B30; }
        .nav-inactive { color: #8E8E93; }
        #drawer {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            width: 80%;
            max-width: 300px;
        }
        #drawer.open { transform: translateX(0); }
        #drawer-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        #drawer-overlay.open { opacity: 1; visibility: visible; }
        .drawer-item { color: #E5E5EA; transition: color 0.2s ease-in-out; }
        .drawer-item.active { color: #FF3B30; font-weight: 600; }
        .drawer-item:hover { color: #FF3B30; }
        button:disabled {
            background-color: #2C2C2E !important;
            color: #555 !important;
            cursor: not-allowed;
            transform: none !important;
            opacity: 0.6;
        }
        select:required:invalid { color: #8E8E93; }
        option { background-color: #2C2C2E; color: white; }
        option:disabled { color: #6b7280; }
        .btn-active { background-color: #FF3B30; color: white; border-color: #FF3B30; }
        .btn-inactive { background-color: transparent; color: #E5E5EA; border-color: #3A3A3C; }
    </style>
</head>
<body class="bg-[#1C1C1E] text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="login-page" class="w-full max-w-md mx-auto fade-in">
        <div class="bg-[#2C2C2E] rounded-xl shadow-lg p-8 space-y-6 border border-[#3A3A3C]">
            <div class="text-center">
                <h1 class="text-2xl font-bold text-white">Acesso Restrito</h1>
                <p class="text-[#8E8E93] mt-1">Faça login para continuar.</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300">Email:</label>
                    <input type="email" id="login-email" required class="mt-1 w-full p-3 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white placeholder-[#8E8E93] focus:ring-2 focus:ring-[#FF3B30] focus:border-[#FF3B30] transition">
                </div>
                <div class="relative">
                    <label for="login-password" class="block text-sm font-medium text-gray-300">Senha:</label>
                    <input type="password" id="login-password" required class="mt-1 w-full p-3 pr-10 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white placeholder-[#8E8E93] focus:ring-2 focus:ring-[#FF3B30] focus:border-[#FF3B30] transition">
                    <div id="toggle-password" class="absolute inset-y-0 right-0 top-7 pr-3 flex items-center text-gray-400 cursor-pointer">
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        <svg id="eye-slashed-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542-7 .847 0 1.673.126 2.463.359m-2.964 12.016A9.95 9.95 0 0012 13a3 3 0 100-6 9.95 9.95 0 00-5.012 1.488M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" /></svg>
                    </div>
                </div>
                <button type="submit" id="login-button" class="w-full bg-[#FF3B30] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#E6352A] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#FF3B30] focus:ring-offset-[#2C2C2E] transition-transform transform hover:scale-105">Entrar</button>
            </form>
            <div id="login-error" class="hidden text-center p-3 bg-[#FF3B30]/20 text-[#FF3B30] border border-[#FF3B30]/50 font-medium rounded-lg"></div>
        </div>
    </div>

    <div id="app-container" class="hidden w-full h-full pb-24 relative">
        <div id="app-header" class="fixed top-0 left-0 right-0 bg-[#2C2C2E] h-16 flex items-center px-4 z-40 border-b border-[#3A3A3C]">
            <button id="hamburger-button" class="p-2 -ml-2 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 id="page-title" class="flex-grow text-center text-lg font-semibold text-white -ml-4"></h1>
            <div class="w-6"></div> 
        </div>

        <div id="drawer-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden"></div>

        <div id="drawer" class="fixed top-0 left-0 h-full bg-[#1C1C1E] shadow-xl z-50 flex flex-col pt-16">
            <div class="flex-none p-6 text-center border-b border-[#3A3A3C]" style="flex-basis: 20%;">
                <div class="w-20 h-20 rounded-full bg-[#3A3A3C] mx-auto flex items-center justify-center border-2 border-[#FF3B30] mb-2">
                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </div>
                <p id="drawer-user-name" class="font-semibold text-white text-lg">Avaliador</p>
                <p id="drawer-user-email" class="text-sm text-[#8E8E93]"></p>
            </div>

            <div class="flex-grow flex flex-col justify-center py-4 border-b border-[#3A3A3C]" style="flex-basis: 60%;">
                <button data-page="home" class="drawer-item flex items-center px-6 py-3 text-lg space-x-3 hover:bg-[#2C2C2E] transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span>Dashboard</span>
                </button>
                <button data-page="results" class="drawer-item flex items-center px-6 py-3 text-lg space-x-3 hover:bg-[#2C2C2E] transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>Relatórios</span>
                </button>
                 <button data-page="audit" class="drawer-item flex items-center px-6 py-3 text-lg space-x-3 hover:bg-[#2C2C2E] transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span>Auditoria</span>
                </button>
                <button data-page="placeholder2" class="drawer-item flex items-center px-6 py-3 text-lg space-x-3 hover:bg-[#2C2C2E] transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Ajustes</span>
                </button>
            </div>

            <div class="flex-none py-4" style="flex-basis: 20%;">
                <button data-page="placeholder2" class="drawer-item flex items-center px-6 py-3 text-lg space-x-3 hover:bg-[#2C2C2E] transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9.247a3 3 0 11-4.243 0 3 3 0 014.243 0zM15.712 14.155L14 18l-3.003-2.997m-2.224-2.224l-2.003 2.003M15.712 14.155a5.5 5.5 0 01-5.045 5.045m5.045-5.045c-.328-.328-.597-.686-.81-1.062a4.802 4.802 0 00-2.56-1.02C8.75 12.01 7 10.74 7 9s1.75-3.01 4-3.01c2.25 0 4 1.27 4 3.01 0 1.25-.79 2.54-1.983 3.42"></path></svg>
                    <span>Ajuda</span>
                </button>
                <button id="drawer-logout-button" class="drawer-item flex items-center px-6 py-3 text-lg space-x-3 text-[#FF3B30] hover:bg-[#2C2C2E] transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair</span>
                </button>
            </div>

            <button id="close-drawer-button" class="absolute top-4 right-4 text-white p-2 rounded-full hover:bg-[#3A3A3C]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <main class="pt-20"> 
            <div id="page-home" class="w-full">
                <div class="w-full max-w-2xl mx-auto bg-[#2C2C2E] rounded-xl shadow-lg p-6 md:p-8 space-y-6 border border-[#3A3A3C]">
                    <div class="text-center">
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Checklist Mensal</h1>
                        <p class="text-[#8E8E93] mt-1">Preencha os campos para iniciar</p>
                    </div>
                    <div id="selection-screen" class="space-y-4 fade-in">
                        <div>
                            <label for="mall-select" class="block text-sm font-medium text-gray-300 mb-1">1. Selecione o Shopping:</label>
                            <select id="mall-select" required class="w-full p-3 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white focus:ring-2 focus:ring-[#FF3B30] focus:border-[#FF3B30] transition">
                                <option value="" disabled selected>-- Carregando Shoppings... --</option>
                            </select>
                        </div>
                        <div>
                            <label for="branch-select" class="block text-sm font-medium text-gray-300 mb-1">2. Selecione o Tipo de Loja:</label>
                            <select id="branch-select" required class="w-full p-3 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white focus:ring-2 focus:ring-[#FF3B30] focus:border-[#FF3B30] transition" disabled>
                                <option value="" disabled selected>-- Escolha um Tipo --</option>
                            </select>
                        </div>
                        <div>
                            <label for="store-select" class="block text-sm font-medium text-gray-300 mb-1">3. Selecione a Loja:</label>
                            <select id="store-select" required class="w-full p-3 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white focus:ring-2 focus:ring-[#FF3B30] focus:border-[#FF3B30] transition" disabled>
                                <option value="" disabled selected>-- Escolha uma Loja --</option>
                            </select>
                        </div>
                    </div>
                    <div id="result-screen" class="hidden space-y-4">
                        <div id="status-message" class="text-center p-4 rounded-lg"></div>
                        <button id="new-evaluation-button" class="w-full bg-[#3A3A3C] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#545458]">Fazer Nova Avaliação</button>
                    </div>
                    <div id="checklist-screen" class="hidden space-y-5">
                        <h2 id="checklist-title" class="text-xl font-semibold text-white border-b border-[#3A3A3C] pb-2">Questionário</h2>
                        <div id="questions-container" class="space-y-4"></div>
                        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
                            <button id="pause-button" class="w-full bg-[#FF9500] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#E68600]" disabled>Pausar e Salvar</button>
                            <button id="save-button" class="w-full bg-[#FF3B30] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#E6352A]" disabled>Salvar Avaliação</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-results" class="hidden w-full">
                <div class="w-full max-w-2xl mx-auto bg-[#2C2C2E] rounded-xl shadow-lg p-6 md:p-8 space-y-6 border border-[#3A3A3C]">
                    <div class="text-center">
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Resultados das Avaliações</h1>
                        <p class="text-[#8E8E93] mt-1">Análise de risco por shopping.</p>
                    </div>
                    <div>
                        <label for="results-mall-select" class="block text-sm font-medium text-gray-300 mb-1">Filtrar por Shopping:</label>
                        <select id="results-mall-select" required class="w-full p-3 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white focus:ring-2 focus:ring-[#FF3B30] focus:border-[#FF3B30] transition">
                            <option value="" disabled selected>-- Selecione um Shopping para analisar --</option>
                        </select>
                    </div>
                    <div id="results-content" class="hidden space-y-6">
                        <div id="chart-container" class="p-4 bg-[#3A3A3C]/50 rounded-lg"><canvas id="risk-chart"></canvas></div>
                        <div id="table-container"></div>
                    </div>
                    <div id="results-placeholder" class="text-center py-8"><p class="text-[#8E8E93]">Selecione um shopping para ver os resultados.</p></div>
                </div>
            </div>

            <div id="page-profile" class="hidden w-full">
                <div class="w-full max-w-2xl mx-auto bg-[#2C2C2E] rounded-xl shadow-lg p-6 md:p-8 space-y-6 border border-[#3A3A3C] text-center">
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Perfil do Avaliador</h1>
                        <div class="flex flex-col items-center space-y-4 pt-4">
                            <div class="w-24 h-24 rounded-full bg-[#3A3A3C] flex items-center justify-center border-2 border-[#FF3B30]"><svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
                            <p id="profile-user-email" class="text-lg font-medium text-gray-300"></p>
                            <button id="logout-button" class="w-full max-w-xs bg-[#FF3B30] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#E6352A] transition-colors">Sair (Logout)</button>
                        </div>
                </div>
            </div>

            <div id="page-audit" class="hidden w-full">
                <div class="w-full max-w-2xl mx-auto bg-[#2C2C2E] rounded-xl shadow-lg p-6 md:p-8 space-y-6 border border-[#3A3A3C]">
                    <div class="text-center">
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Central de Auditoria</h1>
                        <p class="text-[#8E8E93] mt-1">Revise os detalhes das avaliações concluídas.</p>
                    </div>
                    <div id="audit-selection-screen" class="space-y-4 fade-in">
                        <div>
                            <label for="audit-mall-select" class="block text-sm font-medium text-gray-300 mb-1">1. Filtre por Shopping:</label>
                            <select id="audit-mall-select" required class="w-full p-3 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white focus:ring-2 focus:ring-[#FF3B30]">
                                <option value="" disabled selected>-- Selecione um Shopping --</option>
                            </select>
                        </div>
                        <div id="audit-list-container" class="space-y-3 pt-4">
                            <p class="text-center text-[#8E8E93]">Selecione um shopping para ver as avaliações.</p>
                        </div>
                    </div>
                    <div id="audit-details-screen" class="hidden space-y-4">
                        <div class="flex justify-between items-center border-b border-[#3A3A3C] pb-2">
                            <h2 id="audit-details-title" class="text-xl font-semibold text-white">Detalhes da Avaliação</h2>
                            <button id="audit-back-button" class="text-sm bg-[#3A3A3C] hover:bg-[#545458] text-white font-bold py-1 px-3 rounded-lg">&larr; Voltar</button>
                        </div>
                        <div id="audit-details-content" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            
            <div id="page-placeholder2" class="hidden w-full"><div class="w-full max-w-2xl mx-auto bg-[#2C2C2E] rounded-xl shadow-lg p-6 md:p-8 space-y-6 border border-[#3A3A3C] text-center"><h1 class="text-2xl md:text-3xl font-bold text-white">Página em Construção</h1></div></div>
        </main>
        
        <nav class="fixed bottom-0 left-0 right-0 bg-[#2C2C2E] border-t border-[#3A3A3C]">
            <div class="grid grid-cols-4 w-full max-w-2xl mx-auto items-center text-center h-20">
                <button id="nav-home" class="nav-active flex flex-col items-center justify-center h-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="text-xs mt-1">Início</span>
                </button>
                <button id="nav-new-evaluation" class="nav-inactive flex flex-col items-center justify-center h-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="text-xs mt-1">Nova Avaliação</span>
                </button>
                <button id="nav-scan" class="nav-inactive flex flex-col items-center justify-center h-full" disabled>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h-1m-1-6v.01M5 12h-1m1-6V5m1-1h1m5 0h1m-1 1v.01M12 12h.01M6 18H5m1-1v.01M18 6h1m-1 1v.01M6 6h.01M18 18h-1m-1 1v-1m-6 1v-1m-1-1H6m12 0h-1m1-1v-1m-6 0V6"></path></svg>
                    <span class="text-xs mt-1">Escanear</span>
                </button>
                <button id="nav-audit" class="nav-inactive flex flex-col items-center justify-center h-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span class="text-xs mt-1">Resultados</span>
                </button>
            </div>
        </nav>
    </div>

<script>
    // --- 1. CONFIGURAÇÃO E INICIALIZAÇÃO DO SUPABASE ---
    const SUPABASE_URL = 'https://aoohkmlpwnbkvtsiyamp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvb2hrbWxwd25ia3Z0c2l5YW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjAwNTEsImV4cCI6MjA3NjE5NjA1MX0.AkGA6X4tB3L2uXFj-fL09nVf1Qmm3JyoxB_-8cMuXVw';
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. VARIÁVEIS GLOBAIS E ELEMENTOS DO DOM ---
    const questions = [ { id: 'q1', text: 'Os funcionários da loja participaram do último treinamento semestral realizado pela área de segurança patrimonial do shopping?', risks: { 'Joalheria': 4, 'Eletroeletrônicos': 4, 'Telefonia': 4, 'Bancos e Caixas Eletrônicos': 4, 'Casas de Câmbio e Lotéricas': 4 } }, { id: 'q2', text: 'A loja dispõe de agentes de segurança em horário de funcionamento? (Aplica-se a joalherias com produtos de altíssimo valor agregado)', risks: { 'Joalheria': 5, 'Bancos e Caixas Eletrônicos': 5 } }, { id: 'q3', text: 'A loja possui protocolos internos de segurança? (Documento escrito)', risks: { 'Joalheria': 3, 'Eletroeletrônicos': 3, 'Telefonia': 3, 'Bancos e Caixas Eletrônicos': 3, 'Casas de Câmbio e Lotéricas': 3 } }, { id: 'q4', text: 'Existem funcionários listados no portal do lojista como "ativos" que foram desligados ou estão afastados?', risks: { 'Joalheria': 3, 'Eletroeletrônicos': 3, 'Telefonia': 3, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 4 } }, { id: 'q5', text: 'A loja, depósito e área de fancoil possuem paredes de alvenaria, incluindo região acima do forro?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 4, 'Telefonia': 4, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q6', text: 'COFRE: A loja possui cofre para guarda de valores em espécie ou peças de valor em área restrita de circulação?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q7', text: 'COFRE: O cofre é ancorado ao piso ou à parede, de forma a evitar que seja movimentado?', risks: { 'Joalheria': 3, 'Eletroeletrônicos': 3, 'Telefonia': 3, 'Bancos e Caixas Eletrônicos': 3, 'Casas de Câmbio e Lotéricas': 3 } }, { id: 'q8', text: 'COFRE: O cofre possui mecanismo de abertura somente em horário programado?', risks: { 'Joalheria': 3, 'Eletroeletrônicos': 3, 'Telefonia': 3, 'Bancos e Caixas Eletrônicos': 3, 'Casas de Câmbio e Lotéricas': 3 } }, { id: 'q9', text: 'A loja possui espaço seguro para guarda de produtos de alto valor em área restrita de circulação?', risks: { 'Joalheria': 3, 'Eletroeletrônicos': 3, 'Telefonia': 3, 'Bancos e Caixas Eletrônicos': 5 } }, { id: 'q10', text: 'A vitrine/mostruário possui trancas em todos os acessos?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5 } }, { id: 'q11', text: 'A vitrine/cabine de recebimento é blindada?', risks: { 'Joalheria': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q12', text: 'Existe exposição de itens de alto valor nas vitrines fora do horário comercial?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5 } }, { id: 'q13', text: 'Existe sinalização informando que a loja está sendo monitorada por sistema de câmeras?', risks: { 'Joalheria': 4, 'Eletroeletrônicos': 4, 'Telefonia': 4, 'Bancos e Caixas Eletrônicos': 4, 'Casas de Câmbio e Lotéricas': 4 } }, { id: 'q14', text: 'A loja possui acesso alternativo (saída para corredor técnico)?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q15', text: 'A porta principal possui fechadura física além do acionamento por controle remoto (redundância)?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q16', text: 'A loja possui sistema de CFTV?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q17', text: 'CFTV: O sistema de CFTV possui capacidade de armazenamento das imagens por no mínimo 30 dias?', risks: { 'Joalheria': 4, 'Eletroeletrônicos': 4, 'Telefonia': 4, 'Bancos e Caixas Eletrônicos': 4, 'Casas de Câmbio e Lotéricas': 4 } }, { id: 'q18', text: 'CFTV: O equipamento de armazenamento das imagens fica em local protegido, evitando o acesso indevido ao equipamento?', risks: { 'Joalheria': 3, 'Eletroeletrônicos': 3, 'Telefonia': 3, 'Bancos e Caixas Eletrônicos': 3, 'Casas de Câmbio e Lotéricas': 3 } }, { id: 'q19', text: 'CFTV: A loja possui pontos cegos relevantes de monitoramento (acessos, expositores, vitrines e estoques)?', risks: { 'Joalheria': 4, 'Eletroeletrônicos': 4, 'Telefonia': 4, 'Bancos e Caixas Eletrônicos': 4, 'Casas de Câmbio e Lotéricas': 4 } }, { id: 'q20', text: 'CFTV: Existe monitoramento ativo do CFTV? (Aplica-se apenas para operações com produtos com altíssimo valor)', risks: { 'Joalheria': 5 } }, { id: 'q21', text: 'A loja possui alarme antipânico?', risks: { 'Joalheria': 3, 'Bancos e Caixas Eletrônicos': 3, 'Casas de Câmbio e Lotéricas': 3 } }, { id: 'q22', text: 'As mercadorias expostas possuem sistema de alarme interligado?', risks: { 'Eletroeletrônicos': 4, 'Telefonia': 4 } }, { id: 'q23', text: 'A loja possui sensor de presença interligado a um alarme sonoro audível?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q24', text: 'Vitrines e mostruários têm sistema antifurto/vandalismo com sensoriamento e alarme sonoro?', risks: { 'Joalheria': 5 } }, { id: 'q25', text: 'Há sensores de portas interligados a alarmes sonoros?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q26', text: 'Os sistemas de proteção instalados estão operacionais?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q27', text: 'O shopping instala sensores de presença (alarme) em lojas desocupadas adjacentes a operações de risco?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } }, { id: 'q28', text: 'O terminal eletrônico do shopping possui câmera dedicada?', risks: { 'Bancos e Caixas Eletrônicos': 5 } }, { id: 'q29', text: 'A segurança realiza vistorias nos terminais eletrônicos com periodicidade durante o plantão?', risks: { 'Bancos e Caixas Eletrônicos': 4 } }, { id: 'q30', text: 'O shopping impõe uma lista prévia para autorizar o acesso dos colaboradores responsáveis pela manutenção dos terminais de saque?', risks: { 'Bancos e Caixas Eletrônicos': 5 } }, { id: 'q31', text: 'A abertura e fechamento de portas da loja é acompanhada por equipe de segurança do shopping?', risks: { 'Joalheria': 4, 'Eletroeletrônicos': 4, 'Telefonia': 4, 'Bancos e Caixas Eletrônicos': 4, 'Casas de Câmbio e Lotéricas': 4 } }, { id: 'q32', text: 'Há limite de horário para operação de recebimento de novas mercadorias / carros forte (das 07h às 09h30)?', risks: { 'Joalheria': 5, 'Eletroeletrônicos': 5, 'Telefonia': 5, 'Bancos e Caixas Eletrônicos': 5, 'Casas de Câmbio e Lotéricas': 5 } } ];
    let currentUser = null, riskChart = null; let allMalls = [], currentMallStores = []; let currentAnswers = {}, relevantQuestions = [];
    
    // Elementos do Login
    const loginPage = document.getElementById('login-page'), appContainer = document.getElementById('app-container'), loginForm = document.getElementById('login-form'), loginEmail = document.getElementById('login-email'), loginPassword = document.getElementById('login-password'), loginButton = document.getElementById('login-button'), loginError = document.getElementById('login-error'), togglePassword = document.getElementById('toggle-password'), eyeIcon = document.getElementById('eye-icon'), eyeSlashedIcon = document.getElementById('eye-slashed-icon');

    // Elementos do Header e Drawer
    const appHeader = document.getElementById('app-header'), hamburgerButton = document.getElementById('hamburger-button'), pageTitle = document.getElementById('page-title'), drawerOverlay = document.getElementById('drawer-overlay'), drawer = document.getElementById('drawer'), drawerUserName = document.getElementById('drawer-user-name'), drawerUserEmail = document.getElementById('drawer-user-email'), drawerLogoutButton = document.getElementById('drawer-logout-button'), closeDrawerButton = document.getElementById('close-drawer-button'), drawerNavItems = document.querySelectorAll('#drawer [data-page]');

    // Elementos de Navegação Inferior
    const navHome = document.getElementById('nav-home'),
          navNewEvaluation = document.getElementById('nav-new-evaluation'),
          navAudit = document.getElementById('nav-audit');

    // Páginas
    const pageHome = document.getElementById('page-home'), pageResults = document.getElementById('page-results'), pageProfile = document.getElementById('page-profile'), pagePlaceholder2 = document.getElementById('page-placeholder2'), pageAudit = document.getElementById('page-audit');

    // Elementos da Página Home (Checklist)
    const mallSelect = document.getElementById('mall-select'), branchSelect = document.getElementById('branch-select'), storeSelect = document.getElementById('store-select'), selectionScreen = document.getElementById('selection-screen'), checklistScreen = document.getElementById('checklist-screen'), checklistTitle = document.getElementById('checklist-title'), questionsContainer = document.getElementById('questions-container'), saveButton = document.getElementById('save-button'), statusMessage = document.getElementById('status-message'), resultScreen = document.getElementById('result-screen'), newEvaluationButton = document.getElementById('new-evaluation-button'), pauseButton = document.getElementById('pause-button');

    // Elementos da Página de Resultados
    const resultsMallSelect = document.getElementById('results-mall-select'), resultsContent = document.getElementById('results-content'), resultsPlaceholder = document.getElementById('results-placeholder'), tableContainer = document.getElementById('table-container');

    // Elementos da Página de Auditoria
    const auditMallSelect = document.getElementById('audit-mall-select'), auditSelectionScreen = document.getElementById('audit-selection-screen'), auditListContainer = document.getElementById('audit-list-container'), auditDetailsScreen = document.getElementById('audit-details-screen'), auditDetailsTitle = document.getElementById('audit-details-title'), auditDetailsContent = document.getElementById('audit-details-content'), auditBackButton = document.getElementById('audit-back-button');
    
    // Elementos da Página de Perfil
    const profileUserEmail = document.getElementById('profile-user-email');


    // --- 3. AUTENTICAÇÃO ---
    supa.auth.onAuthStateChange((event, session) => { 
        if (session && (event === 'SIGNED_IN' || event === 'INITIAL_SESSION')) { 
            currentUser = session.user; 
            loginPage.classList.add('hidden'); 
            appContainer.classList.remove('hidden'); 
            profileUserEmail.textContent = currentUser.email; 
            drawerUserEmail.textContent = currentUser.email;
            if(allMalls.length === 0) {
                iniciarAplicativo(); 
            }
        } else if (event === 'SIGNED_OUT') { 
            currentUser = null; 
            loginPage.classList.remove('hidden'); 
            appContainer.classList.add('hidden'); 
        } 
    });

    loginForm.addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        loginButton.disabled = true; 
        loginButton.textContent = 'Entrando...'; 
        loginError.classList.add('hidden'); 
        const { error } = await supa.auth.signInWithPassword({ email: loginEmail.value, password: loginPassword.value, }); 
        if (error) { 
            loginError.textContent = "Email ou senha inválidos."; 
            loginError.classList.remove('hidden'); 
        } 
        loginButton.disabled = false; 
        loginButton.textContent = 'Entrar'; 
    });

    // --- 4. FUNÇÕES DE DADOS (SUPABASE) ---
    async function fetchMallsFromDB() { const { data, error } = await supa.from('malls').select('*').order('name'); if (error) { console.error("Erro ao buscar shoppings:", error); return []; } return data; }
    async function fetchStoresFromDB(mallId) { const { data, error } = await supa.from('stores').select('*').eq('mallId', mallId); if (error) { console.error("Erro ao buscar lojas:", error); return []; } return data; }
    async function saveOrPauseEvaluation(status) { if (Object.keys(currentAnswers).length === 0) return; const finalButton = (status === 'completed') ? saveButton : pauseButton; const originalText = finalButton.textContent; finalButton.disabled = true; finalButton.textContent = 'Salvando...'; const storeId = storeSelect.value; const mallId = mallSelect.value; const selectedStore = currentMallStores.find(s => s.id == storeId); const monthYear = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`; const evaluationId = `${storeId}_${monthYear}`; const answersData = Object.entries(currentAnswers).map(([qId, data]) => ({ questionId: qId, questionText: questions.find(q => q.id === qId).text, answer: data.answer, risk: (data.answer === 'NÃO' && questions.find(q => q.id === qId).risks[selectedStore.branchName]) ? questions.find(q => q.id === qId).risks[selectedStore.branchName] : 0, observation: data.observation || '', imageUrl: data.imageUrl || '' })); const evaluationData = { id: evaluationId, status, evaluatorEmail: currentUser.email, mallName: allMalls.find(m => m.id == mallId).name, storeId: storeId, storeName: selectedStore.name, storeBranch: selectedStore.branchName, monthYear, answers: answersData, }; const { error } = await supa.from('evaluations').upsert(evaluationData); if (error) { console.error("Erro ao salvar no Supabase:", error); displayStatusMessage('Falha ao salvar. Tente novamente.', 'error', true); } else { const successMessage = status === 'completed' ? 'Avaliação salva com sucesso!' : 'Progresso salvo!'; displayStatusMessage(successMessage, 'success', false); checklistScreen.classList.add('hidden'); selectionScreen.classList.add('hidden'); resultScreen.classList.remove('hidden'); } finalButton.disabled = false; finalButton.textContent = originalText; }
    async function handleFileUpload(event) { const file = event.target.files[0]; const { questionId } = event.target.dataset; if (!file || !questionId) return; const feedbackEl = document.getElementById(`upload-feedback-${questionId}`); const storeId = storeSelect.value; const fileName = `${storeId}/${questionId}-${Date.now()}`; feedbackEl.textContent = 'Enviando...'; saveButton.disabled = true; pauseButton.disabled = true; const { error } = await supa.storage.from('photos').upload(fileName, file); if (error) { console.error("Supabase upload failed:", error); feedbackEl.textContent = 'Erro no upload.'; feedbackEl.style.color = '#FF3B30'; } else { const { data } = supa.storage.from('photos').getPublicUrl(fileName); if (currentAnswers[questionId]) { currentAnswers[questionId].imageUrl = data.publicUrl; } feedbackEl.innerHTML = `<a href="${data.publicUrl}" target="_blank" class="text-[#58A6FF] hover:underline">Imagem enviada!</a>`; } const answeredCount = Object.keys(currentAnswers).length; pauseButton.disabled = answeredCount === 0; saveButton.disabled = answeredCount !== relevantQuestions.length; }
    
    // --- 5. NAVEGAÇÃO E LÓGICA DO APP ---
    const pageTitles = { 'home': 'Início', 'results': 'Resultados', 'profile': 'Perfil', 'audit': 'Auditoria', 'placeholder2': 'Ajustes' };

    function navigateTo(pageName, updateHeader = true) {
        [pageHome, pageResults, pageProfile, pagePlaceholder2, pageAudit].forEach(p => p.classList.add('hidden'));
        [navHome, navNewEvaluation, navAudit].forEach(b => { b.classList.remove('nav-active'); b.classList.add('nav-inactive'); });
        drawerNavItems.forEach(item => item.classList.remove('active'));

        let targetPage, targetNavButton, targetDrawerItem;
        let titleText = pageTitles[pageName] || pageTitles['home'];

        switch(pageName) {
            case 'home': targetPage = pageHome; targetNavButton = navHome; targetDrawerItem = document.querySelector('#drawer button[data-page="home"]'); break;
            case 'results': targetPage = pageResults; targetDrawerItem = document.querySelector('#drawer button[data-page="results"]'); populateResultsFilter(); break;
            case 'profile': targetPage = pageProfile; break;
            case 'audit': targetPage = pageAudit; targetNavButton = navAudit; targetDrawerItem = document.querySelector('#drawer button[data-page="audit"]'); populateAuditFilter(); break;
            case 'placeholder2': targetPage = pagePlaceholder2; targetDrawerItem = document.querySelector('#drawer button[data-page="placeholder2"]'); break;
            default: targetPage = pageHome; targetNavButton = navHome; targetDrawerItem = document.querySelector('#drawer button[data-page="home"]');
        }

        targetPage.classList.remove('hidden');
        if (targetNavButton) { targetNavButton.classList.remove('nav-inactive'); targetNavButton.classList.add('nav-active'); }
        if (targetDrawerItem) { targetDrawerItem.classList.add('active'); }
        if (updateHeader) { pageTitle.textContent = titleText; }
        closeDrawer();
    }

    function openDrawer() { drawer.classList.add('open'); drawerOverlay.classList.add('open'); drawerOverlay.classList.remove('hidden'); }
    function closeDrawer() { drawer.classList.remove('open'); drawerOverlay.classList.remove('open'); setTimeout(() => { drawerOverlay.classList.add('hidden'); }, 300); }
    function populateAuditFilter() { auditMallSelect.innerHTML = '<option value="" disabled selected>-- Selecione um Shopping --</option>'; allMalls.forEach(mall => auditMallSelect.add(new Option(mall.name, mall.id))); auditSelectionScreen.classList.remove('hidden'); auditDetailsScreen.classList.add('hidden'); auditListContainer.innerHTML = '<p class="text-center text-[#8E8E93]">Selecione um shopping para ver as avaliações.</p>'; }
    
    // =======================================================
    // ============= FUNÇÃO DE AUDITORIA ALTERADA ============
    // =======================================================
    async function loadAuditList(mallId) {
        if (!mallId) return;
        auditListContainer.innerHTML = '<p class="text-center text-gray-400">Carregando avaliações...</p>';
        const { data: evaluations, error } = await supa
            .from('evaluations')
            .select('*')
            .eq('mallName', allMalls.find(m => m.id == mallId).name)
            .eq('status', 'completed')
            .order('created_at', { ascending: false });

        if (error || !evaluations || evaluations.length === 0) {
            auditListContainer.innerHTML = '<p class="text-center text-[#8E8E93]">Nenhuma avaliação concluída encontrada.</p>';
            return;
        }

        auditListContainer.innerHTML = '';
        evaluations.forEach(evaluation => {
            // Lógica para determinar o status (risco) e contar observações
            const hasRisk = evaluation.answers.some(ans => ans.answer === 'NÃO');
            const observationCount = evaluation.answers.filter(ans => ans.observation && ans.observation.trim() !== '').length;

            // Determinar classes e ícone com base no risco
            const iconBgColor = hasRisk ? 'bg-red-500/30' : 'bg-green-500/30';
            const iconTextColor = hasRisk ? 'text-red-400' : 'text-green-400';
            const iconSvg = hasRisk
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;

            // Lógica para o texto do subtítulo (singular/plural)
            const subtitleText = `Contém ${observationCount} ${observationCount === 1 ? 'observação' : 'observações'}`;

            // Criar o card com a nova estrutura
            const evalCard = document.createElement('div');
            evalCard.className = 'p-3 bg-[#3A3A3C]/60 rounded-lg hover:bg-[#3A3A3C] cursor-pointer transition-colors flex items-center space-x-4';
            evalCard.innerHTML = `
                <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center ${iconBgColor}">
                    <span class="${iconTextColor}">${iconSvg}</span>
                </div>
                <div class="flex-grow">
                    <h3 class="font-semibold text-white text-lg">${evaluation.storeName}</h3>
                    <p class="text-sm text-[#8E8E93]">${subtitleText}</p>
                </div>
            `;
            
            evalCard.addEventListener('click', () => renderAuditDetails(evaluation));
            auditListContainer.appendChild(evalCard);
        });
    }
    // =======================================================
    // ================= FIM DA ALTERAÇÃO ====================
    // =======================================================

    function renderAuditDetails(evaluation) { auditDetailsTitle.textContent = `Detalhes: ${evaluation.storeName}`; auditDetailsContent.innerHTML = ''; const nonConformities = evaluation.answers.filter(ans => ans.answer === 'NÃO'); if (nonConformities.length === 0) { auditDetailsContent.innerHTML = '<p class="text-center text-[#8E8E93]">Ótimo trabalho! Nenhuma não conformidade encontrada.</p>'; } else { nonConformities.forEach(item => { const detailCard = document.createElement('div'); detailCard.className = 'p-3 border border-[#3A3A3C] rounded-lg'; let imageHTML = item.imageUrl ? `<div class="mt-2"><img src="${item.imageUrl}" alt="Foto da auditoria" class="max-w-full h-auto rounded-lg border border-[#545458]"></div>` : ''; detailCard.innerHTML = `<p class="font-semibold text-gray-300">${item.questionText}</p><p class="mt-1 text-sm text-[#FF9500] bg-[#FF9500]/20 p-2 rounded-md"><strong class="font-bold">Observação:</strong> ${item.observation || 'Nenhuma.'}</p>${imageHTML}`; auditDetailsContent.appendChild(detailCard); }); } auditSelectionScreen.classList.add('hidden'); auditDetailsScreen.classList.remove('hidden'); }
    async function handleStoreSelection() { const storeId = storeSelect.value; checklistScreen.classList.add('hidden'); resultScreen.classList.add('hidden'); if (!storeId) return; const selectedStore = currentMallStores.find(s => s.id == storeId); if (!selectedStore) return; const monthYear = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`; const evaluationId = `${storeId}_${monthYear}`; displayStatusMessage('Verificando...', 'loading', true); const { data } = await supa.from('evaluations').select('*').eq('id', evaluationId).single(); relevantQuestions = questions.filter(q => q.risks[selectedStore.branchName] !== undefined); resultScreen.classList.add('hidden'); statusMessage.classList.add('hidden'); if (data && data.status === 'in_progress') { renderChecklist(selectedStore, data.answers); } else { renderChecklist(selectedStore); } }
    function populateMalls() { mallSelect.innerHTML = '<option value="" disabled selected>-- Escolha um Shopping --</option>'; allMalls.forEach(mall => mallSelect.add(new Option(mall.name, mall.id))); }
    function populateResultsFilter() { resultsMallSelect.innerHTML = '<option value="" disabled selected>-- Selecione um Shopping --</option>'; allMalls.forEach(mall => resultsMallSelect.add(new Option(mall.name, mall.id))); resultsContent.classList.add('hidden'); resultsPlaceholder.classList.remove('hidden');}
    function populateBranches() { branchSelect.innerHTML = '<option value="" disabled selected>-- Escolha um Tipo --</option>'; storeSelect.innerHTML = '<option value="" disabled selected>-- Escolha uma Loja --</option>'; branchSelect.disabled = true; storeSelect.disabled = true; const uniqueBranches = [...new Set(currentMallStores.map(store => store.branchName))]; uniqueBranches.sort().forEach(branch => branchSelect.add(new Option(branch, branch))); branchSelect.disabled = false;}
    async function populateStores(branch) { storeSelect.innerHTML = '<option value="" disabled selected>-- Carregando Lojas... --</option>'; storeSelect.disabled = true; if (!branch) return; const monthYear = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`; const { data: evaluations } = await supa.from('evaluations').select('storeId, status').eq('mallName', allMalls.find(m=>m.id==mallSelect.value).name).eq('monthYear', monthYear); const evaluationsStatus = (evaluations || []).reduce((map, eval) => { map[eval.storeId] = eval.status; return map; }, {}); storeSelect.innerHTML = '<option value="" disabled selected>-- Escolha uma Loja --</option>'; const filteredStores = currentMallStores.filter(store => store.branchName === branch); filteredStores.sort((a,b) => a.name.localeCompare(b.name)).forEach(store => { const status = evaluationsStatus[store.id]; let storeName = store.name, isDisabled = false; if (status === 'completed') { storeName += ' (✓ Concluído)'; isDisabled = true; } else if (status === 'in_progress') { storeName += ' (⏸️ Em Andamento)'; } const option = new Option(storeName, store.id); option.disabled = isDisabled; storeSelect.add(option); }); storeSelect.disabled = false; }
    
    function renderChecklist(selectedStore, savedAnswers = []) {
        questionsContainer.innerHTML = ''; currentAnswers = {}; saveButton.disabled = true; pauseButton.disabled = true; checklistTitle.textContent = `Questionário: ${selectedStore.name}`;
        const savedAnswersMap = savedAnswers.reduce((map, ans) => { map[ans.questionId] = { answer: ans.answer, observation: ans.observation || '', imageUrl: ans.imageUrl || '' }; return map; }, {});
        relevantQuestions.forEach(q => {
            const questionEl = document.createElement('div');
            questionEl.className = 'p-4 border border-[#3A3A3C] rounded-lg fade-in';
            const riskValue = q.risks[selectedStore.branchName];
            questionEl.innerHTML = `<p class="font-medium text-gray-200">${q.text}</p><div class="flex items-center space-x-3 mt-3"><button data-question-id="${q.id}" data-answer="SIM" class="btn-inactive flex-1 py-2 px-4 border rounded-md transition-colors">SIM</button><button data-question-id="${q.id}" data-answer="NÃO" class="btn-inactive flex-1 py-2 px-4 border rounded-md transition-colors">NÃO</button></div><div id="risk-${q.id}" class="hidden mt-2 p-2 bg-[#FF3B30]/20 text-[#FF3B30] font-semibold rounded-md text-sm">Risco: ${riskValue}</div><div id="details-${q.id}" class="hidden mt-4 space-y-3 border-t border-[#3A3A3C] pt-3"><div><label for="obs-${q.id}" class="block text-sm font-medium text-[#8E8E93] mb-1">Observação:</label><textarea id="obs-${q.id}" data-question-id="${q.id}" class="w-full p-2 bg-[#3A3A3C] border border-[#545458] rounded-lg text-white" rows="2"></textarea></div><div><label class="block text-sm font-medium text-[#8E8E93] mb-1">Anexar Foto:</label><div class="flex items-center space-x-2"><button id="upload-btn-${q.id}" class="flex-grow bg-[#5856D6] hover:bg-[#4D4ABF] text-white font-semibold py-2 px-4 rounded-lg">Escolher Arquivo</button><button id="camera-btn-${q.id}" class="p-2 bg-[#3A3A3C] hover:bg-[#545458] rounded-lg"><svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div><input type="file" id="photo-${q.id}" data-question-id="${q.id}" class="hidden" accept="image/*"><div id="upload-feedback-${q.id}" class="text-xs mt-2 text-gray-400"></div></div></div>`;
            questionsContainer.appendChild(questionEl);
            questionEl.querySelector(`#obs-${q.id}`).addEventListener('input', handleObservationInput);
            questionEl.querySelector(`#photo-${q.id}`).addEventListener('change', handleFileUpload);
            questionEl.querySelector(`#upload-btn-${q.id}`).addEventListener('click', () => triggerFileInput(q.id, false));
            questionEl.querySelector(`#camera-btn-${q.id}`).addEventListener('click', () => triggerFileInput(q.id, true));
            const savedData = savedAnswersMap[q.id]; if (savedData) { currentAnswers[q.id] = { answer: savedData.answer, observation: savedData.observation, imageUrl: savedData.imageUrl }; const button = questionEl.querySelector(`button[data-answer="${savedData.answer}"]`); button.classList.add('btn-active'); button.classList.remove('btn-inactive'); questionEl.querySelector(`#obs-${q.id}`).value = savedData.observation; if (savedData.imageUrl) { questionEl.querySelector(`#upload-feedback-${q.id}`).innerHTML = `<a href="${savedData.imageUrl}" target="_blank" class="text-blue-400 hover:underline">Ver imagem salva</a>`; } if (savedData.answer === 'NÃO') { questionEl.querySelector(`#risk-${q.id}`).classList.remove('hidden'); questionEl.querySelector(`#details-${q.id}`).classList.remove('hidden'); } }
        });
        const answeredCount = Object.keys(currentAnswers).length; pauseButton.disabled = answeredCount === 0; saveButton.disabled = answeredCount !== relevantQuestions.length; checklistScreen.classList.remove('hidden'); checklistScreen.classList.add('fade-in');
    }
    
    function triggerFileInput(questionId, useCamera) { const fileInput = document.getElementById(`photo-${questionId}`); if (useCamera) { fileInput.setAttribute('capture', 'environment'); } else { fileInput.removeAttribute('capture'); } fileInput.click(); }
    function handleAnswerSelection(event) { const button = event.target.closest('button'); if (!button || !button.dataset.questionId) return; const { questionId, answer } = button.dataset; if (!currentAnswers[questionId]) { currentAnswers[questionId] = { answer: '', observation: '', imageUrl: '' }; } currentAnswers[questionId].answer = answer; document.querySelectorAll(`button[data-question-id="${questionId}"]`).forEach(btn => { btn.classList.toggle('btn-active', btn.dataset.answer === answer); btn.classList.toggle('btn-inactive', btn.dataset.answer !== answer); }); const riskEl = document.getElementById(`risk-${questionId}`), detailsEl = document.getElementById(`details-${questionId}`); if (answer === 'NÃO') { riskEl.classList.remove('hidden'); detailsEl.classList.remove('hidden'); } else { riskEl.classList.add('hidden'); detailsEl.classList.add('hidden'); currentAnswers[questionId].observation = ''; currentAnswers[questionId].imageUrl = ''; document.getElementById(`obs-${questionId}`).value = ''; } const answeredCount = Object.keys(currentAnswers).length; pauseButton.disabled = answeredCount === 0; saveButton.disabled = answeredCount !== relevantQuestions.length; }
    function handleObservationInput(event) { const { questionId } = event.target.dataset; if (currentAnswers[questionId]) { currentAnswers[questionId].observation = event.target.value; } }
    
    function displayStatusMessage(message, type, showOnTop) {
        statusMessage.textContent = message;
        statusMessage.className = 'text-center p-4 rounded-lg fade-in border';
        if (showOnTop) { selectionScreen.classList.add('hidden'); checklistScreen.classList.add('hidden'); resultScreen.classList.remove('hidden'); newEvaluationButton.classList.toggle('hidden', type === 'loading'); } 
        else { newEvaluationButton.classList.remove('hidden'); }
        switch (type) {
            case 'success': statusMessage.classList.add('bg-[#34C759]/20', 'text-[#34C759]', 'border-[#34C759]/50'); break;
            case 'error': statusMessage.classList.add('bg-[#FF3B30]/20', 'text-[#FF3B30]', 'border-[#FF3B30]/50'); break;
            case 'info': statusMessage.classList.add('bg-[#007AFF]/20', 'text-[#007AFF]', 'border-[#007AFF]/50'); break;
            case 'loading': statusMessage.classList.add('bg-[#FF9500]/20', 'text-[#FF9500]', 'border-[#FF9500]/50'); break;
        }
        statusMessage.classList.remove('hidden');
    }
    async function loadResults(mallId) { if (!mallId) { resultsContent.classList.add('hidden'); resultsPlaceholder.classList.remove('hidden'); resultsPlaceholder.textContent = 'Selecione um shopping.'; return; } resultsPlaceholder.textContent = 'Carregando...'; resultsContent.classList.add('hidden'); resultsPlaceholder.classList.remove('hidden'); const {data: evaluations, error} = await supa.from('evaluations').select('*').eq('mallName', allMalls.find(m=>m.id==mallId).name); if (error || !evaluations || evaluations.length === 0) { resultsPlaceholder.textContent = 'Nenhuma avaliação encontrada.'; return; } renderRiskChart(evaluations); renderResultsTable(evaluations); resultsContent.classList.remove('hidden'); resultsPlaceholder.classList.add('hidden'); }
    
    function renderRiskChart(evaluations) {
        const riskCounts = {};
        evaluations.forEach(evalData => {
            const currentMaxRisk = evalData.answers.reduce((max, ans) => Math.max(max, ans.risk || 0), 0);
            riskCounts[currentMaxRisk] = (riskCounts[currentMaxRisk] || 0) + 1;
        });

        const riskColors = { 0: '#34C759', 1: '#34C759', 2: '#FFD60A', 3: '#FF9F0A', 4: '#FF453A', 5: '#FF0000' };
        const presentRiskLevels = Object.keys(riskCounts).map(Number).sort((a, b) => a - b);
        const chartLabels = presentRiskLevels.map(risk => `Risco ${risk}`);
        const chartData = presentRiskLevels.map(risk => riskCounts[risk]);
        const backgroundColors = presentRiskLevels.map(risk => riskColors[risk]);

        const ctx = document.getElementById('risk-chart').getContext('2d');
        if (riskChart) { riskChart.destroy(); }

        riskChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Lojas por Nível de Risco',
                    data: chartData,
                    backgroundColor: backgroundColors,
                    borderColor: '#2C2C2E',
                    borderWidth: 2
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#E5E5EA', font: { size: 14 } } }, title: { display: true, text: 'Distribuição de Lojas por Risco Máximo', color: '#FFFFFF', font: { size: 16 } } } }
        });
    }

    function renderResultsTable(evaluations) { let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-400"><thead class="text-xs text-gray-300 uppercase bg-[#3A3A3C]"><tr><th scope="col" class="px-6 py-3">Nome da Loja</th><th scope="col" class="px-6 py-3">Ramo</th><th scope="col" class="px-6 py-3 text-center">Risco Máximo</th></tr></thead><tbody>`; evaluations.forEach(evalData => { const maxRisk = evalData.answers.reduce((max, ans) => Math.max(max, ans.risk || 0), 0); tableHTML += `<tr class="bg-[#2C2C2E] border-b border-[#3A3A3C] hover:bg-[#3A3A3C]"><th scope="row" class="px-6 py-4 font-medium text-white whitespace-nowrap">${evalData.storeName}</th><td class="px-6 py-4">${evalData.storeBranch}</td><td class="px-6 py-4 text-center font-bold ${maxRisk > 3 ? 'text-[#FF3B30]' : maxRisk > 1 ? 'text-[#FF9500]' : 'text-[#34C759]'}">${maxRisk}</td></tr>`; }); tableHTML += `</tbody></table></div>`; tableContainer.innerHTML = tableHTML; }
    function resetApp() { populateMalls(); resultScreen.classList.add('hidden'); checklistScreen.classList.add('hidden'); selectionScreen.classList.remove('hidden'); selectionScreen.classList.add('fade-in'); mallSelect.value = ''; branchSelect.innerHTML = '<option value="" disabled selected>-- Escolha um Tipo --</option>'; branchSelect.disabled = true; storeSelect.innerHTML = '<option value="" disabled selected>-- Escolha uma Loja --</option>'; storeSelect.disabled = true; currentAnswers = {}; relevantQuestions = []; currentMallStores = []; navigateTo('home'); }
    async function iniciarAplicativo() { allMalls = await fetchMallsFromDB(); resetApp(); populateResultsFilter(); }

    // --- 6. EVENT LISTENERS ---
    togglePassword.addEventListener('click', () => { const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password'; loginPassword.setAttribute('type', type); eyeIcon.classList.toggle('hidden'); eyeSlashedIcon.classList.toggle('hidden'); });
    hamburgerButton.addEventListener('click', openDrawer);
    drawerOverlay.addEventListener('click', closeDrawer);
    closeDrawerButton.addEventListener('click', closeDrawer);
    drawerLogoutButton.addEventListener('click', async () => { await supa.auth.signOut(); closeDrawer(); });
    drawerNavItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)) );
    navHome.addEventListener('click', () => navigateTo('home'));
    navNewEvaluation.addEventListener('click', () => navigateTo('home'));
    navAudit.addEventListener('click', () => navigateTo('audit'));
    mallSelect.addEventListener('change', async () => { const mallId = mallSelect.value; branchSelect.innerHTML = '<option value="" disabled selected>-- Carregando Tipos... --</option>'; branchSelect.disabled = true; storeSelect.disabled = true; if (!mallId) return; currentMallStores = await fetchStoresFromDB(mallId); populateBranches(); });
    branchSelect.addEventListener('change', () => populateStores(branchSelect.value));
    storeSelect.addEventListener('change', handleStoreSelection);
    questionsContainer.addEventListener('click', handleAnswerSelection);
    saveButton.addEventListener('click', () => saveOrPauseEvaluation('completed'));
    pauseButton.addEventListener('click', () => saveOrPauseEvaluation('in_progress'));
    newEvaluationButton.addEventListener('click', resetApp);
    resultsMallSelect.addEventListener('change', (e) => loadResults(e.target.value));
    auditMallSelect.addEventListener('change', (e) => loadAuditList(e.target.value));
    auditBackButton.addEventListener('click', () => { auditDetailsScreen.classList.add('hidden'); auditSelectionScreen.classList.remove('hidden'); });

</script>

</body>
</html>
